---
name: Binary Size Tracking

"on":
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

permissions:
  contents: read
  pull-requests: write

jobs:
  track-size:
    name: Track Binary Size
    runs-on: ubuntu-latest
    strategy:
      matrix:
        goos: [linux, darwin]
        goarch: [amd64, arm64]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.21"
          cache: true

      - name: Build binary
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: 0
        run: |
          BINARY_NAME="github-actions-runner-version-${{ matrix.goos }}-${{ matrix.goarch }}"

          BUILD_TIME=$(date -u '+%Y-%m-%d_%H:%M:%S')
          GIT_COMMIT=$(git rev-parse --short HEAD)

          LDFLAGS="-w -s"
          LDFLAGS="${LDFLAGS} -X main.Version=dev"
          LDFLAGS="${LDFLAGS} -X main.BuildTime=${BUILD_TIME}"
          LDFLAGS="${LDFLAGS} -X main.GitCommit=${GIT_COMMIT}"

          go build \
            -trimpath \
            -ldflags="${LDFLAGS}" \
            -o "${BINARY_NAME}" \
            .

          # Get size in bytes and MB
          SIZE_BYTES=$(stat -c%s "${BINARY_NAME}" 2>/dev/null || stat -f%z "${BINARY_NAME}")
          SIZE_MB=$(echo "scale=2; ${SIZE_BYTES}/1024/1024" | bc)

          echo "BINARY_NAME=${BINARY_NAME}" >> $GITHUB_ENV
          echo "SIZE_BYTES=${SIZE_BYTES}" >> $GITHUB_ENV
          echo "SIZE_MB=${SIZE_MB}" >> $GITHUB_ENV

      - name: Upload size info
        uses: actions/upload-artifact@v4
        with:
          name: size-${{ matrix.goos }}-${{ matrix.goarch }}
          path: |
            ${{ env.BINARY_NAME }}
          retention-days: 7

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const os = '${{ matrix.goos }}';
            const arch = '${{ matrix.goarch }}';
            const sizeBytes = parseInt('${{ env.SIZE_BYTES }}');
            const sizeMB = '${{ env.SIZE_MB }}';

            // Warning thresholds
            const warningMB = 10;  // Warn if > 10MB
            const errorMB = 12;    // Error if > 12MB

            let emoji = '‚úÖ';
            let message = 'Binary size is good';

            if (sizeMB > errorMB) {
              emoji = 'üî¥';
              message = `Binary is larger than ${errorMB}MB threshold!`;
            } else if (sizeMB > warningMB) {
              emoji = '‚ö†Ô∏è';
              message = `Binary is approaching size threshold (${warningMB}MB)`;
            }

            const comment = `${emoji} **Binary Size Report: ${os}/${arch}**

            - **Size**: ${sizeMB}MB (${sizeBytes.toLocaleString()} bytes)
            - **Status**: ${message}

            <details>
            <summary>Size Guidelines</summary>

            - ‚úÖ Good: < ${warningMB}MB
            - ‚ö†Ô∏è Warning: ${warningMB}-${errorMB}MB
            - üî¥ Too Large: > ${errorMB}MB

            Current target: **< 8MB** (Phase 1 optimizations)
            Future target: **< 5MB** (if go-github replaced with net/http)
            </details>`;

            // Only comment once per PR (check existing comments)
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes(`Binary Size Report: ${os}/${arch}`)
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

  summary:
    name: Create Size Summary
    needs: track-size
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Download all size artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: size-*
          path: artifacts

      - name: Create summary
        run: |
          echo "## Binary Size Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Size |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|------|" >> $GITHUB_STEP_SUMMARY

          for dir in artifacts/size-*; do
            if [ -d "$dir" ]; then
              binary=$(find "$dir" -type f -name "github-actions-runner-version-*" | head -1)
              if [ -f "$binary" ]; then
                platform=$(basename "$dir" | sed 's/size-//')
                size=$(stat -c%s "$binary" 2>/dev/null || stat -f%z "$binary")
                size_mb=$(echo "scale=2; $size/1024/1024" | bc)
                echo "| $platform | ${size_mb}MB |" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Target**: < 8MB for Phase 1 optimizations" >> $GITHUB_STEP_SUMMARY
