---
name: Check Runner Version

"on":
  schedule:
    # Run daily at 9 AM UTC
    - cron: "0 9 * * *"
  workflow_dispatch:
    inputs:
      runner-version:
        description: >-
          Runner version to check (optional, defaults to auto-detect or latest)
        required: false
        type: string
      runs-on:
        description: Runner to use
        required: true
        type: choice
        options:
          - ubuntu-latest
          - self-hosted
        default: ubuntu-latest

jobs:
  check-version:
    runs-on: ${{ inputs.runs-on || 'self-hosted' }}
    steps:
      - name: Get runner version
        id: runner-version
        run: |
          # If version provided via input, use that
          if [ -n "${{ inputs.runner-version }}" ]; then
            VERSION="${{ inputs.runner-version }}"
            echo "Using provided version: $VERSION"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
          # Try to auto-detect on self-hosted runner
          elif [ -f "$RUNNER_HOME/.runner" ]; then
            VERSION=$(cat "$RUNNER_HOME/.runner" | jq -r '.agentVersion')
            echo "Detected self-hosted runner version: $VERSION"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
          # GitHub-hosted runner - fetch versions for dual demonstration
          else
            echo "Running on GitHub-hosted runner - fetching for demo"
            # Get the two most recent versions from GitHub API
            API_URL="https://api.github.com/repos/actions/runner/releases"
            VERSIONS=$(curl -s "${API_URL}?per_page=2" | \
              jq -r '.[].tag_name' | sed 's/^v//')
            LATEST=$(echo "$VERSIONS" | head -1)
            PREVIOUS=$(echo "$VERSIONS" | tail -1)

            echo "Latest runner version: $LATEST"
            echo "Previous runner version: $PREVIOUS"

            # Export both for demonstration steps
            echo "version=$LATEST" >> $GITHUB_OUTPUT
            echo "latest=$LATEST" >> $GITHUB_OUTPUT
            echo "previous=$PREVIOUS" >> $GITHUB_OUTPUT
          fi

      - name: Download version checker
        run: |
          REPO="nickromney-org/github-actions-runner-version"
          BINARY="github-actions-runner-version-linux-amd64"
          URL="https://github.com/${REPO}/releases/latest/download"
          curl -LO "${URL}/${BINARY}"
          chmod +x "${BINARY}"
          sudo mv "${BINARY}" /usr/local/bin/github-actions-runner-version

      - name: "Example 1: Check latest version (current status)"
        id: check-latest
        if: steps.runner-version.outputs.latest != ''
        run: |
          VERSION="${{ steps.runner-version.outputs.latest }}"
          echo "::notice::Demonstrating: Latest version check"
          echo "Checking version: $VERSION"
          github-actions-runner-version -c "${VERSION}" --ci
        continue-on-error: true

      - name: "Example 2: Check previous version (warning + expiry table)"
        id: check-previous
        if: steps.runner-version.outputs.previous != ''
        run: |
          VERSION="${{ steps.runner-version.outputs.previous }}"
          echo "::notice::Demonstrating: Previous version with full output"
          echo "Checking version: $VERSION"
          github-actions-runner-version -c "${VERSION}" --ci
        continue-on-error: true

      - name: Check self-hosted runner version
        id: check-selfhosted
        if: |
          steps.runner-version.outputs.version != '' &&
          steps.runner-version.outputs.latest == ''
        run: |
          VERSION="${{ steps.runner-version.outputs.version }}"
          echo "Checking self-hosted runner version: $VERSION"
          github-actions-runner-version -c "${VERSION}" --ci
        continue-on-error: true

      - name: Create issue if expired
        if: |
          steps.check-selfhosted.conclusion == 'failure' &&
          steps.runner-version.outputs.latest == ''
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ steps.runner-version.outputs.version }}';
            const title = `ðŸš¨ Self-hosted runner version ${version} is expired`;
            const body = `
            ## Runner Version Expired

            **Runner:** \`${{ runner.name }}\`
            **Current Version:** \`${version}\`

            The runner version has exceeded the 30-day update policy
            and will no longer receive jobs from GitHub Actions.

            ### Action Required
            Update the runner to the latest version immediately.

            See the [workflow run](${{ github.server_url }}/${{
            github.repository }}/actions/runs/${{ github.run_id }})
            for details.
            `;

            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'runner-version-expired'
            });

            const existingIssue = issues.data.find(issue =>
              issue.title.includes(version) && issue.title.includes('expired')
            );

            if (!existingIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['runner', 'runner-version-expired', 'critical']
              });
            }
