name: Check Runner Version

on:
  schedule:
    # Run daily at 9 AM UTC
    - cron: "0 9 * * *"
  workflow_dispatch:
    inputs:
      runner-version:
        description: "Runner version to check (optional, defaults to auto-detect)"
        required: false
        type: string

jobs:
  check-version:
    runs-on: self-hosted
    steps:
      - name: Get runner version
        id: runner-version
        run: |
          # Try to auto-detect runner version
          if [ -f "$RUNNER_HOME/.runner" ]; then
            VERSION=$(cat "$RUNNER_HOME/.runner" | jq -r '.agentVersion')
            echo "Detected runner version: $VERSION"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
          elif [ -n "${{ inputs.runner-version }}" ]; then
            VERSION="${{ inputs.runner-version }}"
            echo "Using provided version: $VERSION"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
          else
            echo "::error::Could not detect runner version. Please specify manually."
            exit 1
          fi

      - name: Download version checker
        run: |
          curl -LO https://github.com/nickromney-org/github-actions-runner-version/releases/latest/download/github-actions-runner-version-linux-amd64
          chmod +x github-actions-runner-version-linux-amd64
          sudo mv github-actions-runner-version-linux-amd64 /usr/local/bin/github-actions-runner-version

      - name: Check version compliance
        id: check
        run: |
          # GITHUB_TOKEN is automatically detected - no need to pass -t flag
          github-actions-runner-version -c ${{ steps.runner-version.outputs.version }} --ci
        continue-on-error: true

      - name: Create issue if expired
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ steps.runner-version.outputs.version }}';
            const title = `üö® Self-hosted runner version ${version} is expired`;
            const body = `
            ## Runner Version Expired

            **Runner:** \`${{ runner.name }}\`
            **Current Version:** \`${version}\`

            The runner version has exceeded the 30-day update policy and will no longer receive jobs from GitHub Actions.

            ### Action Required
            Update the runner to the latest version immediately.

            See the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.
            `;

            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'runner-version-expired'
            });

            const existingIssue = issues.data.find(issue =>
              issue.title.includes(version) && issue.title.includes('expired')
            );

            if (!existingIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['runner', 'runner-version-expired', 'critical']
              });
            }

      - name: Send Slack notification if critical
        if: steps.check.outcome == 'success'
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "‚ö†Ô∏è Runner version check completed",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Runner Version Status*\n\nRunner: `${{ runner.name }}`\nVersion: `${{ steps.runner-version.outputs.version }}`\n\nView details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true
